---

#############################################################################
##
##  Auto-Ozmeka
##  T McIntyre for UTS EResearch 2015-2016
##
#############################################################################


- hosts: all
  user: vagrant
  sudo: yes
  tasks:

#    - selinux: state=disabled    # permissive default seems ok


#############################################################################
##
##  Prep and dependencies
##
#############################################################################

    - hostname: name={{ hostname }}

    - name: install debugging tools
      yum: >
        name={{ item }}
        state=latest
      with_items:
        - telnet
        - lynx
        - mlocate
        - lsof
    
    - name: install apache
      yum: >
        pkg=httpd
        state=latest
      register: httpdinstalled
      
    - name: Enable virtual hosts
      lineinfile: >
        line="NameVirtualHost *:80"
        dest=/etc/httpd/conf/httpd.conf
        state=present
      when: httpdinstalled|success
       
    - name: Install Ozmeka vhost config
      template: >
        src=templates/25-ozmeka.conf.j2
        dest=/etc/httpd/conf.d/25-ozmeka.conf
        owner=root
        group=wheel
        mode=0644
      when: httpdinstalled|success

    - name: install php & ancillaries
      yum: >
        name={{ item }}
        state=latest
      with_items:
        - php
        - php-xml
        - php-pear
        - php-mysqli

    - name: enable and start apache
      service: >
        name=httpd
        state=started
        enabled=yes

    - name: install mariadb
      yum: >
        name={{ item }}
        state=latest
      with_items:
        - mariadb-server
        - MySQL-python  # bindings for ansible modules to use
      register: mariadbinstalled
      
    - name: enable and start mariadb
      service: >
        name=mariadb
        state=started
        enabled=yes

#    - template: src=templates/my.cnf.j2 dest=/etc/my.cnf owner=root group=wheel mode=0644
#      when: mariadbinstalled|success
#      notify:
#      - restart mariadb-server

    - name: ImageMagick
      yum: >
        pkg=ImageMagick
        state=latest
      
    - name: java (openjdk)
      yum: >
        pkg=java-{{ openjdk_version }}-openjdk
        state=latest


#############################################################################
##
##  Omeka core
##
#############################################################################

    - name: check if omeka core is present already
      stat: path=/var/www/html/omeka-{{ omeka_version }}/index.php
      register: omekacoreexists
      
 #   - debug: var=omekacoreexists.stat.exists
    
    - name: fetch omeka core
      get_url: >
        url=http://omeka.org/files/omeka-{{ omeka_version }}.zip
        dest=/tmp/omeka-{{ omeka_version }}.zip
      register: omekacorearchivefetched
      when: not omekacoreexists.stat.exists
      
    - name: extract omeka core
      unarchive: >
        dest=/var/www/html/
        src=/tmp/omeka-{{ omeka_version }}.zip  creates=/var/www/html/omeka-{{ omeka_version }}/index.php
        copy=no
      register: omekacoreextracted
      when: omekacorearchivefetched|success

    - name: db details for omeka
      template: >
        dest=/var/www/html/omeka-{{ omeka_version }}/db.ini 
        src=templates/db.ini.j2
        owner=root
        group=wheel
        mode=0644
    
    - name: make omeka files dir writable by apache
      command: /bin/chown -R apache:apache /var/www/html/omeka-{{ omeka_version }}/files/

    - name: enable display of PHP and application errors
      lineinfile: >
        dest=/var/www/html/omeka-{{ omeka_version }}/.htaccess
        line='SetEnv APPLICATION_ENV development'
        regexp='SetEnv\sAPPLICATION_ENV'
        state=present
      when: omekacoreextracted|success
      
    - name: create omeka db
      mysql_db: >
        name=omeka_db
        state=present
    - name: create omeka db user
      mysql_user: >
        name=omeka
        password={{ db_password }}
        priv=omeka_db.*:ALL
        state=present


#############################################################################
##
##  Ozmeka plugins 
##
#############################################################################

    - include_vars: group_vars/plugins.yml

#    - debug: var=omeka_plugins

    - name: check if omeka plugins are present already
      stat: "path=/var/www/html/omeka-{{ omeka_version }}/plugins/{{ item.key }}"
      register: omekaplugin_exists
      with_dict: "{{ omeka_plugins }}"

#    - debug: var=omekaplugin_exists

    - name: fetch omeka plugins
      get_url: >
        dest=/tmp/{{ item.item.key }}.tar.gz
        url="{{ item.item.value.uri }}" 
      register: ozmekaplugin_fetched
      when: not item.stat.exists
      with_items: "{{ omekaplugin_exists.results }}"
      
    - debug: var=ozmekaplugin_fetched
      
    - name: extract ozmeka plugins
      unarchive: >
        src=/tmp/{{ item.item.item.key }}.tar.gz
        dest=/tmp/
        creates=/var/www/html/omeka-{{ omeka_version }}/plugins/{{ item.item.item.key }}/plugin.ini
        copy=no
#      register: ozmekaplugin_extracted
      with_items: "{{ ozmekaplugin_fetched.results }}"
      when: ozmekaplugin_fetched.changed
      
    - name: rename plugins to suit Omeka
      command: "mv /tmp/{{ item.item.value.extracts_as }} /var/www/html/omeka-{{ omeka_version }}/plugins/{{ item.item.key }} creates=/var/www/html/omeka-{{ omeka_version }}/plugins/{{ item.item.key }} removes=/tmp/{{ item.item.value.extracts_as }}"
      when: not item.stat.exists
      with_items: "{{ omekaplugin_exists.results }}"
      
      
#############################################################################
##
##  Theme
##
#############################################################################

    # the Ozmeka Seasons theme mod improves image and file browsing

    - name: check if stock theme has been moved aside
      stat: path=/var/www/html/omeka-{{ omeka_version }}/themes/seasons.stock
      register: stockthemeaside
      
    - name: move stock seasons theme aside
      command: mv /var/www/html/omeka-{{ omeka_version }}/themes/seasons /var/www/html/omeka-{{ omeka_version }}/themes/seasons.stock
      
    - name: fetch omeka modified seasons theme
      get_url: >
        dest=/tmp/seasons-ozmeka-v{{ theme_version }}.tar.gz
        url=https://github.com/ozmeka/theme-seasons/archive/{{ theme_version }}.tar.gz 
      register: ozmekathemefetched
      when: not stockthemeaside.stat.exists
      
    - name: extract ozmeka seasons theme
      unarchive: >
        dest=/var/www/html/omeka-{{ omeka_version }}/themes/ 
        src=/tmp/seasons-ozmeka-v{{ theme_version }}.tar.gz
        copy=no
      register: omekathemeextracted
      when: ozmekathemefetched|success
      
    - name: rename theme to suit omeka
      command: mv /var/www/html/omeka-{{ omeka_version }}/themes/theme-seasons-{{ theme_version }} /var/www/html/omeka-{{ omeka_version }}/themes/seasons
      

#############################################################################
##
##  Solr
##
#############################################################################

    - name: check if solr is present already
      stat: path=/usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/bin/solr-undertow
      register: solrexists
      
    - name: create solr directory 
      file: >
        path=/usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/
        mode=775
        state=directory
      
    - name: fetch solr bundle
      get_url: >
        dest=/tmp/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}.tgz
        url=https://github.com/bremeld/solr-undertow/releases/download/v{{ undertow_version }}/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}.tgz 
      register: solrarchivefetched
      when: not solrexists.stat.exists
      
    - name: extract solr bundle
      unarchive: >
        dest=/usr/local/ creates=/usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/bin/solr-undertow 
        src=/tmp/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}.tgz
        copy=no
      register: solrextracted
      when: solrarchivefetched|success
      
    - name: check solr has omeka config
      stat: path=/usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/omeka/omeka.conf
      register: solrconfigexists
      
    - name: configure solr for omeka - create config dir
      command: cp -a /usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/example /usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/omeka
      when: not solrconfigexists.stat.exists

    - name: configure solr for omeka - remove example configs
      command: rm -f /usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/omeka/*.conf
      when: not solrconfigexists.stat.exists

    - name: configure solr for omeka - install solr-undertow config
      template: >
        dest=/usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/omeka/omeka.conf
        src=templates/omeka.conf.j2
        owner=root
        group=wheel
        mode=0644
      
    - name: configure solr for omeka - install solr.xml
      template: >
        dest=/usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/omeka/solr-home/solr.xml 
        src=templates/solr.xml.j2
        owner=root
        group=wheel
        mode=0644
      
    - name: configure solr for omeka - link solr to omeka plugin config
      file: >
        dest=/usr/local/solr-undertow-{{ undertow_version }}-with-solr-{{ solr_version }}/omeka/solr-home/omeka 
        src=/var/www/html/omeka-{{ omeka_version }}/plugins/SolrSearch/solr-core/omeka
        state=link
      
    - name: check solr init script
      stat: path=/etc/init.d/solr-undertow
      register: solrinitexists
      
    - name: init script for solr-undertow
      template: >
        dest=/etc/init.d/solr-undertow
        src=templates/solr-undertow-init.sh.j2
        owner=root
        group=wheel
        mode=0755
      
    - name: enable solr service
      service: >
        name=solr-undertow
        state=started
        enabled=yes